function StorageUtil(){if(this._INDEXEDDBNOTSUPPORTED="indexedDB is not supported by the browser",this._DBALREADYEXISTS="DB: {0} already exists",this._DBCREATIONFAILED="Creating DB: {0} failed",this._TABLECREATIONFAILED="Creating table: {0} failed",this._TABLEEXISTS="Table: {0} is already exists in {1}",this._READWRITE="readwrite",this._DELETEDBFAILED="Deleting DB has failed",this._INSERTRECORDFAILED="Insert record failed",this._UPDATEFAILED="Update records failed",this._READRECORDFAILED="Read Records failed",this._READONLY="readonly",this._ISDBEXISTS="Failed to check if DB: {0} exists",this._RECORDNOTEXISTS="Record: {0} not exists",this._ISTABLEEXISTS="Failed to check if table: {0} exists",this._ErrorEnum={indexedDBNotSupportedError:1,dbAlreadyExistsError:2,tableCreationFailed:3,dbCreationFailed:4,tableExistsError:5,isDBExistsError:8,updateFailed:9,deleteRecordsFailed:10,readRecordFailed:11,deletingDBFailed:12,recordNotExists:13,insertRecordFailed:14,isTableExistsFailed:15},this._indexedDB=void 0,!this._isBrowserSupportsIndexedDB())throw new StorageUtilException(this._ErrorEnum.indexedDBNotSupportedError,this._INDEXEDDBNOTSUPPORTED);this._indexedDB=window.indexedDB}function StorageUtilException(a,b,c){return{errorCode:a,errorMessage:b,errorObject:c}}StorageUtil.prototype._isBrowserSupportsIndexedDB=function(){return window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB,window.indexedDB)?!0:!1},StorageUtil.prototype._closeDB=function(a){a&&a.close()},StorageUtil.prototype.createDB=function(a){var b,c=Q.defer(),d=this;try{var e=!0,f=d._indexedDB.open(a);f.onsuccess=function(f){b=f.target.result,d._closeDB(b),e?c.reject(new StorageUtilException(d._ErrorEnum.dbAlreadyExistsError,d._format(d._DBALREADYEXISTS,a))):c.resolve()},f.onerror=function(b){c.reject(new StorageUtilException(d._ErrorEnum.dbCreationFailed,d._format(d._DBCREATIONFAILED,a),b))},f.onupgradeneeded=function(){e=!1}}catch(g){d._closeDB(b),c.reject(new StorageUtilException(d._ErrorEnum.dbCreationFailed,d._format(d._DBCREATIONFAILED,a),g))}return c.promise},StorageUtil.prototype.isDBExists=function(a){var b,c=Q.defer(),d=this;try{var e=this._indexedDB.open(a),f=!0;e.onsuccess=function(g){e.result.close(),b=g.target.result,f?(d._closeDB(b),c.resolve(!0)):(d._indexedDB.deleteDatabase(a),d._closeDB(b),c.resolve(!1))},e.onupgradeneeded=function(){f=!1},e.onerror=function(b){c.reject(new StorageUtilException(d._ErrorEnum.isDBExistsError,d._format(d._ISDBEXISTS,a),b))}}catch(g){d._closeDB(b),c.reject(new StorageUtilException(d._ErrorEnum.isDBExistsError,d._format(d._ISDBEXISTS,a),g))}return c.promise},StorageUtil.prototype.createTable=function(a,b){var c,d,e=Q.defer(),f=this;try{var g=f._indexedDB.open(a);g.onsuccess=function(g){c=g.target.result;var h=c.version;h+=1,f._closeDB(c);var i=f._indexedDB.open(a,h);i.onerror=function(a){e.reject(new StorageUtilException(f._ErrorEnum.tableCreationFailed,f._format(f._TABLECREATIONFAILED,b),a))},i.onupgradeneeded=function(c){d=c.target.result,d.objectStoreNames.contains(b)?(f._closeDB(d),e.reject(new StorageUtilException(f._ErrorEnum.tableExistsError),f._format(f._TABLEEXISTS,b,a),c)):(d.createObjectStore(b),f._closeDB(d),e.resolve())}},g.onerror=function(a){e.reject(new StorageUtilException(f._ErrorEnum.tableCreationFailed,f._format(f._TABLECREATIONFAILED,b),a))}}catch(h){f._closeDB(c),f._closeDB(d),e.reject(new StorageUtilException(f._ErrorEnum.tableCreationFailed,f._format(f._TABLECREATIONFAILED,b),h))}return e.promise},StorageUtil.prototype.insertRecords=function(a,b,c){var d,e=Q.defer(),f=this;try{var g,h,i=0,j=this._indexedDB.open(a);j.onsuccess=function(a){function j(){i<c.length?(h.put(c[i].value,c[i].key).onsuccess=j,i++):(f._closeDB(d),e.resolve())}d=a.target.result,g=d.transaction([b],f._READWRITE),h=g.objectStore(b),j()},j.onerror=function(a){e.reject(new StorageUtilException(f._ErrorEnum.insertRecordFailed,f._format(f._INSERTRECORDFAILED,b),a))}}catch(k){f._closeDB(d),e.reject(new StorageUtilException(f._ErrorEnum.insertRecordFailed,f._format(f._INSERTRECORDFAILED,b),k))}return e.promise},StorageUtil.prototype.isTableExists=function(a,b){var c,d=Q.defer(),e=this;try{var f,g,h=e._indexedDB.open(a);h.onsuccess=function(a){c=a.target.result;try{f=c.transaction([b],e._READWRITE)}catch(h){return e._closeDB(c),void d.resolve(!1)}g=f.objectStore(b),e._closeDB(c),d.resolve(g?!0:!1)},h.onerror=function(){d.reject(new StorageUtilException(e._ErrorEnum.isTableExistsFailed,e._format(e._ISTABLEEXISTS,b),i))}}catch(i){e._closeDB(c),d.reject(new StorageUtilException(e._ErrorEnum.isTableExistsFailed,e._format(e._ISTABLEEXISTS,b),i))}return d.promise},StorageUtil.prototype.updateRecords=function(a,b,c){var d,e=this,f=Q.defer();try{var g,h,i=-1,j=this._indexedDB.open(a);j.onsuccess=function(a){function j(){if(i++,i<c.length){var a=h.openCursor(c[i].key);a.onsuccess=function(a){var b=a.target.result;b?h.put(c[i].value,c[i].key).onsuccess=j:(k.push(c[i].key),j())},a.onerror=function(a){e._closeDB(d),f.reject(new StorageUtilException(e._ErrorEnum.recordNotExists,e._format(e._RECORDNOTEXISTS,c[i].key),a))}}else e._closeDB(d),f.resolve(k)}d=a.target.result,g=d.transaction([b],e._READWRITE),h=g.objectStore(b);var k=[];j()},j.onerror=function(a){f.reject(new StorageUtilException(e._ErrorEnum.updateFailed,e._UPDATEFAILED,a))}}catch(k){e._closeDB(d),f.reject(new StorageUtilException(e._ErrorEnum.updateFailed,e._UPDATEFAILED,k))}return f.promise},StorageUtil.prototype.deleteAllRecords=function(a,b){var c,d=Q.defer(),e=this;try{var f,g,h=e._indexedDB.open(a);h.onsuccess=function(a){c=a.target.result,f=c.transaction([b],e._READWRITE),g=f.objectStore(b);var h=g.clear();h.onsuccess=function(){e._closeDB(c),d.resolve()},h.onerror=function(a){e._closeDB(c),d.reject(new StorageUtilException(e._ErrorEnum.deleteRecordsFailed,e._DELETERECORDFAILED,a))}},h.onerror=function(a){d.reject(new StorageUtilException(e._ErrorEnum.deleteRecordsFailed,e._DELETERECORDFAILED,a))}}catch(i){e._closeDB(c),d.reject(new StorageUtilException(e._ErrorEnum.deleteRecordsFailed,e._DELETERECORDFAILED,i))}return d.promise},StorageUtil.prototype.deleteRecords=function(a,b,c){var d,e=this,f=Q.defer();try{var g,h,i=0,j=e._indexedDB.open(a);j.onsuccess=function(a){function j(){i<c.length?(h.delete(c[i]).onsuccess=j,i++):(e._closeDB(d),f.resolve())}d=a.target.result,g=d.transaction([b],e._READWRITE),h=g.objectStore(b),j()},j.onerror=function(){f.reject(new StorageUtilException(e._ErrorEnum.deleteRecordsFailed,e._DELETERECORDFAILED,k))}}catch(k){e._closeDB(d),f.reject(new StorageUtilException(e._ErrorEnum.deleteRecordsFailed,e._DELETERECORDFAILED,k))}return f.promise},StorageUtil.prototype.readRecord=function(a,b,c){var d,e=Q.defer(),f=this;try{var g,h,i=f._indexedDB.open(a);i.onsuccess=function(a){d=a.target.result,g=d.transaction([b],f._READONLY),h=g.objectStore(b);var i=h.get(c);i.onsuccess=function(a){f._closeDB(d),e.resolve(a.target.result)},i.onerror=function(a){f._closeDB(d),e.reject(new StorageUtilException(f._ErrorEnum.readRecordFailed,f._READRECORDFAILED,a))}}}catch(j){f._closeDB(d),e.reject(new StorageUtilException(f._ErrorEnum.readRecordFailed,f._READRECORDFAILED,j))}return e.promise},StorageUtil.prototype.readAllRecords=function(a,b){var c,d,e,f=Q.defer(),g=this,h={},i=0;try{var j=g._indexedDB.open(a);j.onsuccess=function(a){e=a.target.result,c=e.transaction([b],g._READONLY),d=c.objectStore(b),d.openCursor().onsuccess=function(a){var b=a.target.result;b?(h[i]={key:b.key,value:b.value},b.continue(),i++):(g._closeDB(e),f.resolve(h))}},j.onerror=function(a){f.reject(new StorageUtilException(g._ErrorEnum.readRecordFailed,g._READRECORDFAILED,a))}}catch(k){g._closeDB(e),f.reject(new StorageUtilException(g._ErrorEnum.readRecordFailed,g._READRECORDFAILED,k))}return f.promise},StorageUtil.prototype.deleteDB=function(a){var b=this,c=Q.defer();try{var d=b._indexedDB.deleteDatabase(a);d.onsuccess=function(){c.resolve()},d.onerror=function(a){c.reject(new StorageUtilException(b._ErrorEnum.deletingDBFailed,b._DELETEDBFAILED,a))}}catch(e){c.reject(new StorageUtilException(b._ErrorEnum.deletingDBFailed,b._DELETEDBFAILED,e))}return c.promise},StorageUtil.prototype._format=function(a,b){return b="object"==typeof b?b:Array.prototype.slice.call(arguments,1),a.replace(/\{\{|\}\}|\{(\w+)\}/g,function(a,c){return"{{"===a?"{":"}}"===a?"}":b[c]})};